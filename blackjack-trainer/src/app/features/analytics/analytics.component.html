<mat-card>
	<div *ngIf="history().length; else empty">
		<p>
			<strong>Total Attempts:</strong> {{ totAttempts() }} | <strong>Total Correct:</strong> {{ totCorrect() }} |
			<strong>Accuracy:</strong> {{ accuracy() | number: '1.0-1' }}% | <strong>Avg Time:</strong>
			{{ avgTime() | number: '1.0-0' }} ms | <strong>Streak:</strong> {{ streaks().current }} (Best
			{{ streaks().best }})
		</p>
		<p>
			<strong>Hint Use (Drill):</strong> {{ hintUsage().withHint }} / {{ hintUsage().total }} ({{
				hintUsage().hintRate | number: '1.0-1'
			}}%)
		</p>
		<h3>Per-Action Accuracy</h3>
		<table mat-table [dataSource]="actionStats()" *ngIf="actionStats().length" class="mat-elevation-z2">
			<ng-container matColumnDef="action">
				<th mat-header-cell *matHeaderCellDef>Action</th>
				<td mat-cell *matCellDef="let a">{{ a.action }}</td>
			</ng-container>
			<ng-container matColumnDef="attempts">
				<th mat-header-cell *matHeaderCellDef>Attempts</th>
				<td mat-cell *matCellDef="let a">{{ a.attempts }}</td>
			</ng-container>
			<ng-container matColumnDef="correct">
				<th mat-header-cell *matHeaderCellDef>Correct</th>
				<td mat-cell *matCellDef="let a">{{ a.correct }}</td>
			</ng-container>
			<ng-container matColumnDef="acc">
				<th mat-header-cell *matHeaderCellDef>Accuracy%</th>
				<td mat-cell *matCellDef="let a">{{ a.acc * 100 | number: '1.0-1' }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['action', 'attempts', 'correct', 'acc']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['action', 'attempts', 'correct', 'acc']"></tr>
		</table>
		<div *ngIf="actionStats().length">
			<h4>Per-Action Trend (Rolling)</h4>
			<div class="action-trends">
				<div class="action-trend" *ngFor="let a of actionStats()">
					<label>{{ a.action }}</label>
					<div class="mini-spark">
						<span
							*ngFor="let p of actionTrends()[a.action]"
							[style.height.%]="p"
							[attr.title]="p.toFixed(1) + '%'"
						></span>
					</div>
				</div>
			</div>
		</div>
		<h3>Recent Sessions</h3>
		<table mat-table [dataSource]="recent()" class="mat-elevation-z2" *ngIf="recent().length">
			<ng-container matColumnDef="ts">
				<th mat-header-cell *matHeaderCellDef>Date/Time</th>
				<td mat-cell *matCellDef="let h">{{ h.ts | date: 'short' }}</td>
			</ng-container>
			<ng-container matColumnDef="mode">
				<th mat-header-cell *matHeaderCellDef>Mode</th>
				<td mat-cell *matCellDef="let h">{{ h.mode }}</td>
			</ng-container>
			<ng-container matColumnDef="correct">
				<th mat-header-cell *matHeaderCellDef>Correct</th>
				<td mat-cell *matCellDef="let h">{{ h.correct }}</td>
			</ng-container>
			<ng-container matColumnDef="attempts">
				<th mat-header-cell *matHeaderCellDef>Attempts</th>
				<td mat-cell *matCellDef="let h">{{ h.attempts }}</td>
			</ng-container>
			<ng-container matColumnDef="acc">
				<th mat-header-cell *matHeaderCellDef>Acc%</th>
				<td mat-cell *matCellDef="let h">{{ (h.correct / h.attempts) * 100 | number: '1.0-1' }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['ts', 'mode', 'correct', 'attempts', 'acc']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['ts', 'mode', 'correct', 'attempts', 'acc']"></tr>
		</table>
		<h3>Rolling Accuracy (Last 50)</h3>
		<div class="spark">
			<span *ngFor="let p of spark()" [style.height.%]="p" [attr.title]="p.toFixed(1) + '%'"></span>
		</div>
		<h3>Weakest Scenarios (min 3 attempts)</h3>
		<table mat-table [dataSource]="weakest()" *ngIf="weakest().length" class="mat-elevation-z2">
			<ng-container matColumnDef="scenario">
				<th mat-header-cell *matHeaderCellDef>Scenario</th>
				<td mat-cell *matCellDef="let w">{{ w.scenario }}</td>
			</ng-container>
			<ng-container matColumnDef="attempts">
				<th mat-header-cell *matHeaderCellDef>Attempts</th>
				<td mat-cell *matCellDef="let w">{{ w.attempts }}</td>
			</ng-container>
			<ng-container matColumnDef="accuracy">
				<th mat-header-cell *matHeaderCellDef>Accuracy%</th>
				<td mat-cell *matCellDef="let w">{{ w.acc * 100 | number: '1.0-1' }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['scenario', 'attempts', 'accuracy']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['scenario', 'attempts', 'accuracy']"></tr>
		</table>
		<h3>Hardest Actions (min 5 attempts)</h3>
		<table mat-table [dataSource]="hardestActions()" *ngIf="hardestActions().length" class="mat-elevation-z2">
			<ng-container matColumnDef="action">
				<th mat-header-cell *matHeaderCellDef>Action</th>
				<td mat-cell *matCellDef="let ha">{{ ha.action }}</td>
			</ng-container>
			<ng-container matColumnDef="attempts">
				<th mat-header-cell *matHeaderCellDef>Attempts</th>
				<td mat-cell *matCellDef="let ha">{{ ha.attempts }}</td>
			</ng-container>
			<ng-container matColumnDef="accuracy">
				<th mat-header-cell *matHeaderCellDef>Accuracy%</th>
				<td mat-cell *matCellDef="let ha">{{ ha.acc * 100 | number: '1.0-1' }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['action', 'attempts', 'accuracy']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['action', 'attempts', 'accuracy']"></tr>
		</table>
		<h3>Decision Time Distribution</h3>
		<table mat-table [dataSource]="timeDist()" *ngIf="timeDist().length" class="mat-elevation-z2">
			<ng-container matColumnDef="bucket">
				<th mat-header-cell *matHeaderCellDef>Bucket</th>
				<td mat-cell *matCellDef="let b">{{ b.bucket }}</td>
			</ng-container>
			<ng-container matColumnDef="count">
				<th mat-header-cell *matHeaderCellDef>Count</th>
				<td mat-cell *matCellDef="let b">{{ b.count }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['bucket', 'count']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['bucket', 'count']"></tr>
		</table>
		<h3>Overdue SRS Items (Top 10)</h3>
		<table mat-table [dataSource]="overdue()" *ngIf="overdue().length" class="mat-elevation-z2">
			<ng-container matColumnDef="scenario">
				<th mat-header-cell *matHeaderCellDef>Scenario</th>
				<td mat-cell *matCellDef="let o">{{ o.key }}</td>
			</ng-container>
			<ng-container matColumnDef="overdue">
				<th mat-header-cell *matHeaderCellDef>Overdue (min)</th>
				<td mat-cell *matCellDef="let o">{{ o.overdueMinutes }}</td>
			</ng-container>
			<ng-container matColumnDef="ef">
				<th mat-header-cell *matHeaderCellDef>EF</th>
				<td mat-cell *matCellDef="let o">{{ o.ef | number: '1.0-2' }}</td>
			</ng-container>
			<ng-container matColumnDef="lapses">
				<th mat-header-cell *matHeaderCellDef>Lapses</th>
				<td mat-cell *matCellDef="let o">{{ o.lapses || 0 }}</td>
			</ng-container>
			<tr mat-header-row *matHeaderRowDef="['scenario', 'overdue', 'ef', 'lapses']"></tr>
			<tr mat-row *matRowDef="let row; columns: ['scenario', 'overdue', 'ef', 'lapses']"></tr>
		</table>
		<p><strong>Average Decision Time:</strong> {{ avgTime() | number: '1.0-0' }} ms</p>
		<button (click)="reset()">Reset Stats</button>
	</div>
	<ng-template #empty>
		<p>No stats yet. Use Drill or Flashcards to generate data.</p>
	</ng-template>
</mat-card>
